{% extends 'page.html' %}
{% load staticfiles %}

{% block stylesheets %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'css/dataset.css' %}">
{% endblock %}

{% block content %}

    <div class="container">

      <!-- Header and controls area -->
      <div class="row dataset-heading">
        <div class="col-md-12">
          {% block dataset-heading %}
          <h2 class="dataset-title pull-left">
            {% block dataset-title %}
            <i class="fa fa-cubes text-muted"></i>
            <a href="{{ dataset.owner.get_absolute_url }}">{{ dataset.owner.name }}</a>
            /
            <a href="{{ dataset.get_absolute_url }}"><strong>{{ dataset.name }}</strong></a>
            {% endblock %}
          </h2>

          <div class="pull-right">
          {% block dataset-controls %}
            <button class="btn btn-xs btn-default" data-toggle="modal" data-target="#notImplementedYetModal">
              <i class="fa fa-star"></i> Star
            </button>

            <!-- TODO: only show if the user has permissions to edit this! -->
            <button class="btn btn-xs btn-default" data-toggle="modal" data-target="#editDatasetInfoModal">
              <i class="fa fa-edit"></i> Edit Info
            </button>
          {% endblock %}
          </div>

          <div class="clearfix"></div>

          {% endblock %}
        </div>
      </div><!-- header and tabs -->

      {% block tabs %}
      <!-- Tab navigation and panes -->
      <div class="row">
        <div class="col-md-12">

          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" {% if panel_name == "files" %}class="active"{% endif %}>
              <a href="{% url 'dataset:detail' dataset.owner.name dataset.name %}">
                <i class="fa fa-folder-open"></i> Files
              </a>
            </li>
            <li role="presentation" {% if panel_name == "schema" %}class="active"{% endif %}>
              <a href="{% url 'dataset:schema' dataset.owner.name dataset.name %}">
                <i class="fa fa-table"></i> Schema
              </a>
            </li>
            <li role="presentation" {% if panel_name == "explore" %}class="active"{% endif %}>
              <a href="{% url 'dataset:explore' dataset.owner.name dataset.name %}">
                <i class="fa fa-area-chart"></i> Explore
              </a>
            </li>
            <li role="presentation" {% if panel_name == "settings" %}class="active"{% endif %}>
              <a href="{% url 'dataset:settings' dataset.owner.name dataset.name %}">
                <i class="fa fa-cog"></i> Settings
              </a>
            </li>
          </ul>

        </div>
      </div>
      {% endblock %}

      <!-- Tab Panel -->
      {% block panel %}

      {% endblock %}

    </div><!-- container ends -->

{% endblock %}

{% block modals %}
  {{ block.super }}
  {% include 'components/modals/edit-dataset-info.html' %}
  {% include 'components/modals/edit-dataset-readme.html' %}
{% endblock %}

{% block javascripts %}
  {{ block.super }}
  <script type="text/javascript">
    $(document).ready(function() {

      // Configure the dataset application
      var csrfToken   = $('input[name="csrfmiddlewaretoken"]').val();
      $.ajaxSetup({headers: {"X-CSRFToken": csrfToken}});

      /*
       * Trigger for when a file is changed in the upload button
       * http://www.abeautifulsite.net/whipping-file-inputs-into-shape-with-bootstrap-3/
       */
      $(document).on('change', '.btn-file :file', function() {
          var input = $(this),
              numFiles = input.get(0).files ? input.get(0).files.length : 1,
              label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
          input.trigger('fileselect', [numFiles, label]);
      });

      // Handle the fileselect event
      $('.btn-file :file').on('fileselect', function(event, numFiles, label) {
          $("#uploadIcon").removeClass("fa-upload").addClass("fa-spinner").addClass("fa-spin");
          $("#uploadForm").submit();
      });

      /*
       * Handle the dataset info editing forms
       */
      function handleDatasetInfo(event) {
        event.preventDefault();

        var form   = $(event.target);
        var url    = form.attr('action');
        var method = form.attr('method');
        var data   = utils.formData(form);

        console.log(url,method, data);

        // Clean the data from the form
        delete data.csrfmiddlewaretoken

        $.ajax({
            "url": url,
            "method": method,
            "data": JSON.stringify(data),
            "contentType": "application/json"
        }).done(function(data) {
            // Reload the page with the new information.
            location.reload(true);
        }).fail(function(xhr) {
            data = xhr.responseJSON;
            // Set the error
            $.each(data, function(key, val) {
                var field = $("#"+key);
                field.parent().addClass("has-error");
                field.parent().find('.help-block').text(val);
            });
        });
        return false;
      }

      // Register handlers
      $("#editDatasetInfoModal").submit(handleDatasetInfo);
      $("#editDatasetReadmeModal").submit(handleDatasetInfo);


      // Ready to handle datasets!
      console.log("Ready to manage a dataset!");

    });
  </script>
{% endblock %}
